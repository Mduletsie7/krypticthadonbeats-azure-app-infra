stages:
  - build
  - scan

variables:
  REGISTRY_URI: 865494649634.dkr.ecr.us-east-1.amazonaws.com
  REPO_NAME: krypticthadonbeats-dev
  DOCKER_TAG: $CI_COMMIT_SHA
  DOCKER_IMAGE: $REGISTRY_URI/$REPO_NAME:$DOCKER_TAG

build:
  stage: build
  image: docker:latest
  services:
    - docker:dind
  rules:
    - if: '$CI_COMMIT_BRANCH == "develop"'
  before_script:
    - apk add --no-cache aws-cli
    - aws configure set aws_access_key_id "$AWS_ACCESS_KEY_ID"
    - aws configure set aws_secret_access_key "$AWS_SECRET_ACCESS_KEY"
    - aws configure set region "$AWS_REGION"
  script:
    # Login to ECR
    - aws ecr get-login-password --region $AWS_REGION | docker login --username AWS --password-stdin $REGISTRY_URI
    
    # Build and push Docker image
    - echo "Building Docker image..."
    - cd application/frontend
    - docker build -t $REPO_NAME:$DOCKER_TAG .
    - docker tag $REPO_NAME:$DOCKER_TAG $DOCKER_IMAGE
    - echo "Pushing to ECR..."
    - docker push $DOCKER_IMAGE
  after_script:
    - docker logout $REGISTRY_URI


container_scanning:
  stage: scan
  image: docker:latest
  services:
    - docker:dind
  needs: ["build"]
  rules:
    - if: '$CI_COMMIT_BRANCH == "develop"'
  before_script:
    - apk add --no-cache curl
  script:
      # Login to ECR
    - aws ecr get-login-password --region $AWS_REGION | docker login --username AWS --password-stdin $REGISTRY_URI
    # Install Docker Scout
    - curl -fsSL https://raw.githubusercontent.com/docker/scout-cli/main/install.sh -o install-scout.sh
    - sh install-scout.sh
    # Authenticate Docker Scout
    - echo "$DOCKER_SCOUT_TOKEN" | docker login -u "$DOCKER_SCOUT_HUB_USERNAME" --password-stdin
    # Run CVES scan
    - docker scout cves $DOCKER_IMAGE > cves-report.txt
    # Quickview with potential failure on critical issues
    - docker scout quickview $DOCKER_IMAGE
  artifacts:
    paths:
      - cves-report.txt
    when: always
  after_script:
    - docker logout $REGISTRY_URI