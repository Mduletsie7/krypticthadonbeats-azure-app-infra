stages:
  - build_compile
  - test
  - code_scanning
  - build_image
  - container_scanning
  - deploy

include:
  - template: Security/SAST.gitlab-ci.yml
  - template: Security/Dependency-Scanning.gitlab-ci.yml
  - template: Security/Container-Scanning.gitlab-ci.yml
  - template: Security/Secret-Detection.gitlab-ci.yml

variables:
  REGISTRY_URI: 865494649634.dkr.ecr.us-east-1.amazonaws.com
  REPO_NAME: krypticthadonbeats-dev
  IMAGE_TAG: $CI_COMMIT_SHA
  DOCKER_IMAGE: $REGISTRY_URI/$REPO_NAME:$IMAGE_TAG

# Anchors
.aws-config: &aws_config
    - apk add --no-cache aws-cli
    - aws configure set aws_access_key_id "$AWS_ACCESS_KEY_ID"
    - aws configure set aws_secret_access_key "$AWS_SECRET_ACCESS_KEY"
    - aws configure set region "$AWS_REGION"


build_compile:
  stage: build_compile
  image: node:20-alpine
  script:
    - cd application/frontend
    - npm ci 
    - unset CI
    - npm run build
  artifacts:
    paths:
      - "application/frontend/dist"

test:
  stage: test
  image: node:20-alpine
  dependencies:
    - build_compile 
  script:
    - cd application/frontend
    - npm ci
    - npm run test -- --watchAll=false

build_image:
  stage: build_image
  image: docker:latest
  services:
    - docker:dind
  rules:
    - if: '$CI_COMMIT_BRANCH == "develop"'
  before_script:
    - *aws_config
  script:
    - aws ecr get-login-password --region $AWS_REGION | docker login --username AWS --password-stdin $REGISTRY_URI
    - echo "Building Docker image..."
    - cd application/frontend
    - docker build -t $REPO_NAME:$IMAGE_TAG .
    - docker tag $REPO_NAME:$IMAGE_TAG $DOCKER_IMAGE
    - echo "Pushing to ECR..."
    - docker push $DOCKER_IMAGE
  after_script:
    - docker logout $REGISTRY_URI


container_scanning:
  stage: container_scanning
  image: docker:latest
  services:
    - docker:dind
  needs: ["build_image"]
  rules:
    - if: '$CI_COMMIT_BRANCH == "develop"'
  before_script:
    - *aws_config
  script:
    - aws ecr get-login-password --region $AWS_REGION | docker login --username AWS --password-stdin $REGISTRY_URI
    # Install Docker Scout
    - curl -fsSL https://raw.githubusercontent.com/docker/scout-cli/main/install.sh -o install-scout.sh
    - sh install-scout.sh
    # Authenticate Docker Scout
    - echo "$DOCKER_SCOUT_TOKEN" | docker login -u "$DOCKER_SCOUT_HUB_USERNAME" --password-stdin
    # Run CVES scan
    - docker scout cves $DOCKER_IMAGE > cves-report.txt
    # Quickview with potential failure on critical issues
    - docker scout quickview $DOCKER_IMAGE
  artifacts:
    paths:
      - cves-report.txt
    when: always
  after_script:
    - docker logout $REGISTRY_URI

deploy:
  stage: deploy
  image: alpine:latest
  rules:
    - if: '$CI_COMMIT_BRANCH == "develop"'
  script:
    - echo "Getting ready for lift off... 3... 2... 1... Deployed!"